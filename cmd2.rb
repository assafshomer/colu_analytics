data = [{:piwik_id=>13145, :piwik_visitor=>"963eda2f2028b544", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454938689, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13123, :piwik_visitor=>"1206349518826dbd", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454932557, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13111, :piwik_visitor=>"e26c3adab8ad5124", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454932167, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP", :user=>"monoceros.fenix%40gmail.com"}, {:piwik_id=>13116, :piwik_visitor=>"f451897d421f3efa", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454931849, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13118, :piwik_visitor=>"91de1c95771f939a", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454931179, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13107, :piwik_visitor=>"322ee7668493fdfe", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454930113, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13091, :piwik_visitor=>"b4af243211e040df", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454928337, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13078, :piwik_visitor=>"2abb09e2a8e98105", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454927945, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13086, :piwik_visitor=>"74f38142b3cd49c9", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454926612, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13093, :piwik_visitor=>"70c120ff312ba2c5", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454925820, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13074, :piwik_visitor=>"092a31fca334f6af", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454923817, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13075, :piwik_visitor=>"ef094178dfe3901e", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454920694, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13072, :piwik_visitor=>"f462435563b5e9dc", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454919934, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13031, :piwik_visitor=>"4ce050dfeb93b3f5", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454916634, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, {:piwik_id=>13029, :piwik_visitor=>"9d9d263659d0852e", :ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :timestamp=>1454904733, :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}]

filtered_data = [
	{:ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP"}, 
	{:ip=>"92.245.104.129", :country=>"Kyrgyzstan", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP", :user=>"monoceros.fenix%40gmail.com"},
	{:ip=>"92.245.104.129", :country=>"Kyrgyzsta", :city=>nil, :flag=>"plugins/UserCountry/images/flags/kg.png", :asset_id=>"U6Y81Pv71NtU15BqWHcqjqePKPEfkq88q9rqP", :user=>"monoceros.fenix%40gmail.com"}
	]


p data.map{|dp| dp.select{|k,v| !k.to_s.match(/piwik|timestamp/)}}.uniq.inject{|m,x| m.merge(x)}

list = [:ip, :country, :city, :asset_id]
r = []
tmp = filtered_data
tmp.each do |x|
	succint = x.select{|k,v| list.include?(k)}
	r= filtered_data.map do |fd|
		if fd.select{|k,v| list.include?(k)} == succint
			fd.merge(x)
		else
			fd
		end
	end.uniq
end

p r